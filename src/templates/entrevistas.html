<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestión de Entrevistas</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="/static/js/icons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <style>
    :root{--bg:#f5f7fa;--card:#fff;--muted:#6c7a89;--accent:#1f4e79}
    body{font-family:'Inter',system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:#20323a;margin:0;padding:22px}
    .container{max-width:1100px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  </style>
</head>
<body>
  {% raw %}
  <style>
    #sidebar{position:fixed;top:0;bottom:0;left:0;width:220px;background:linear-gradient(180deg,#18324a 0%,#1f4e79 100%);padding:18px 12px;color:#fff;display:flex;flex-direction:column;gap:12px;box-shadow:2px 0 12px rgba(20,30,40,0.08);} 
    #sidebar .brand{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    #sidebar .logo{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    #sidebar a{color:white;font-weight:600;padding:10px 14px;display:flex;align-items:center;gap:10px;text-decoration:none;border-left:4px solid transparent;border-radius:6px}
    #sidebar a.sidebar-active{background:rgba(255,255,255,0.06);border-left-color:rgba(255,255,255,0.18)}
    #content{margin-left:240px;padding-top:18px}
    @media(max-width:900px){#sidebar{display:none}#content{margin-left:0}}
    #sidebar a .icon img{width:18px;height:18px;object-fit:cover;border-radius:4px;display:inline-block}
  </style>
  {% endraw %}

  {% include '_sidebar.html' %}

  <div id="content" class="container">
    <div class="topbar">
      <h2>Gestión de Entrevistas</h2>
      <div>
        <button id="newBtn" class="btn btn-primary">Programar entrevista</button>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="form-row mb-2">
          <div class="col-md-3">
            <select id="filterEstado" class="form-control">
              <option value="">Todos (estado)</option>
              <option value="programada">Programada</option>
              <option value="realizada">Realizada</option>
              <option value="reprogramada">Reprogramada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div class="col-md-3">
            <input id="filterPuesto" class="form-control" placeholder="Filtrar por puesto">
          </div>
          <div class="col-md-3">
            <input id="filterCandidato" class="form-control" placeholder="Filtrar por candidato">
          </div>
          <div class="col-md-3 text-right">
            <button id="refreshBtn" class="btn btn-outline-secondary">Actualizar</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover" id="entrevistasTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Puesto</th>
                <th>Candidato</th>
                <th>Tipo</th>
                <th>Medio</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="entrevistasBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal programar/editar -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Programar entrevista</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <form id="editForm">
            <div class="form-group"><label>Puesto</label><input id="e_puesto" class="form-control" readonly></div>
            <div class="form-group"><label>Candidato</label><select id="e_candidato" class="form-control"></select></div>
            <div class="form-row">
              <div class="col-md-6 form-group"><label>Fecha</label><input id="e_fecha" type="date" class="form-control"></div>
              <div class="col-md-6 form-group"><label>Hora</label><input id="e_hora" type="time" class="form-control"></div>
            </div>
            <div class="form-group"><label>Tipo</label><select id="e_tipo" class="form-control"><option value="presencial">Presencial</option><option value="virtual">Virtual</option></select></div>
            <div class="form-group"><label>Medio / contacto</label><input id="e_medio" class="form-control"></div>
            <div class="form-group"><label>Observaciones internas</label><textarea id="e_obs" class="form-control" rows="3"></textarea></div>
            <div class="form-group"><label>Estado</label><select id="e_estado" class="form-control"><option value="programada">Programada</option><option value="realizada">Realizada</option><option value="reprogramada">Reprogramada</option><option value="cancelada">Cancelada</option></select></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button id="saveBtn" class="btn btn-primary">Guardar</button></div>
      </div>
    </div>
  </div>

<script>
$(function(){
  var entrevistas = [];
  var editingId = null;

  function loadList(){
    $.get('/api/entrevistas', function(data){ entrevistas = data || []; render(); });
  }

  function render(){
    var body = $('#entrevistasBody'); body.empty();
    if(!entrevistas.length){ body.append($('<tr>').append($('<td colspan="7" class="text-center text-muted">').text('No hay entrevistas programadas.'))); return; }
    entrevistas.forEach(function(it){
      var tr = $('<tr>').data('it', it);
      tr.append($('<td>').text(it.fecha || ''));
      tr.append($('<td>').text(it.puesto || ''));
      tr.append($('<td>').text(it.candidato || ''));
      tr.append($('<td>').text(it.tipo || ''));
      tr.append($('<td>').text(it.medio || ''));
      tr.append($('<td>').text(it.estado || ''));
      var actions = $('<td>');
      var btnEdit = $('<button class="btn btn-sm btn-outline-secondary mr-1">Editar</button>').on('click', function(){ openEdit(it); });
      var btnHistory = $('<button class="btn btn-sm btn-outline-primary mr-1">Historial</button>').on('click', function(){ openHistory(it.candidato); });
      var btnExport = $('<button class="btn btn-sm btn-outline-secondary">Exportar</button>').on('click', function(){ exportJson(it); });
      actions.append(btnEdit).append(btnHistory).append(btnExport);
      tr.append(actions);
      body.append(tr);
    });
  }

  function openEdit(it){
    editingId = it.id || null;
    $('#e_puesto').val(it.puesto||'');
    populateCandidates(it.puesto, function(){ $('#e_candidato').val(it.candidato||''); });
    if(it.fecha){ try{ var d = new Date(it.fecha); $('#e_fecha').val(it.fecha.split('T')[0]); }catch(e){} }
    if(it.fecha && it.fecha.indexOf('T')>-1){ $('#e_hora').val(it.fecha.split('T')[1].slice(0,5)); }
    $('#e_tipo').val(it.tipo||'presencial');
    $('#e_medio').val(it.medio||'');
    $('#e_obs').val(it.observaciones||'');
    $('#e_estado').val(it.estado||'programada');
    $('#editModal').modal('show');
  }

  function openNew(){
    editingId = null;
    $('#editForm')[0].reset();
    // candidato selector will be filled after choosing puesto via a small chooser: we'll show all selected candidates
    populateCandidates(null);
    $('#editModal').modal('show');
  }

  function populateCandidates(puesto, cb){
    // load selected candidates from /api/selecciones
    $.get('/api/selecciones', function(data){ var opts = []; var sel = $('#e_candidato'); sel.empty(); (data||[]).forEach(function(s){ if(!puesto || s.puesto===puesto) sel.append($('<option>').val(s.candidato).text(s.candidato + ' — ' + (s.puesto||'') )); }); if(cb) cb(); });
  }

  function save(){
    var puesto = $('#e_puesto').val().trim();
    var candidato = $('#e_candidato').val();
    var fecha = $('#e_fecha').val(); var hora = $('#e_hora').val();
    if(!puesto || !candidato || !fecha){ alert('Puesto, candidato y fecha son obligatorios'); return; }
    var iso = fecha + 'T' + (hora||'00:00') + ':00';
    var payload = { puesto: puesto, candidato: candidato, fecha: iso, tipo: $('#e_tipo').val(), medio: $('#e_medio').val(), observaciones: $('#e_obs').val(), estado: $('#e_estado').val() };
    if(editingId){
      $.ajax({ url: '/api/entrevistas/' + editingId, method: 'PUT', contentType: 'application/json', data: JSON.stringify(payload), success:function(){ $('#editModal').modal('hide'); loadList(); }, error:function(){ alert('Error guardando'); } });
    } else {
      $.ajax({ url: '/api/entrevistas', method: 'POST', contentType: 'application/json', data: JSON.stringify(payload), success:function(){ $('#editModal').modal('hide'); loadList(); }, error:function(){ alert('Error creando'); } });
    }
  }

  function openHistory(candidato){
    // show history of interviews for candidate
    $.get('/api/entrevistas', { candidato: candidato }, function(data){ var html = '<h5>Historial de entrevistas — ' + candidato + '</h5>'; if(!data || data.length===0) html += '<p>No hay entrevistas</p>'; else { html += '<ul>'; data.forEach(function(it){ html += '<li>' + (it.fecha||'') + ' — ' + (it.estado||'') + ' — ' + (it.observaciones||'') + '</li>'; }); html += '</ul>'; } $('#detailContent').html(html); $('#detailModal').modal('show'); });
  }

  function exportJson(it){ var blob = new Blob([JSON.stringify(it, null, 2)], {type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='entrevista_'+(it.id||'')+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

  $('#newBtn').on('click', openNew);
  $('#saveBtn').on('click', save);
  $('#refreshBtn').on('click', loadList);
  $('#filterEstado, #filterPuesto, #filterCandidato').on('change keyup', function(){ applyFilters(); });

  function applyFilters(){ var estado = $('#filterEstado').val(); var puesto = $('#filterPuesto').val(); var candidato = $('#filterCandidato').val(); $.get('/api/entrevistas', { estado: estado, puesto: puesto, candidato: candidato }, function(data){ entrevistas = data || []; render(); }); }

  // small modal for candidate history
  $('body').append('<div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Detalle</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body"><div id="detailContent"></div></div><div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal">Cerrar</button></div></div></div></div>');

  loadList();
});
</script>
<script>
  (function(){
    document.querySelectorAll('#sidebar a .icon').forEach(function(span){
      var iconPath = span.getAttribute('data-icon') || span.dataset.icon;
      if(!iconPath) return;
      try{ var img = document.createElement('img'); img.src = iconPath; img.alt = ''; img.loading='lazy'; span.innerHTML=''; span.appendChild(img); }catch(e){console.warn('No se pudo cargar icono:', iconPath)}
    });
  })();
</script>
</body>
</html>