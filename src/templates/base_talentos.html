<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Base de Talentos</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="/static/js/icons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        :root{--bg:#f5f7fa;--card:#fff;--muted:#6c7a89;--accent:#1f4e79;--border:#e6e9ee}
        body{font-family:'Inter',system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:#20323a;margin:0;padding:22px}
        .container{max-width:1100px}
        .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
        .topbar h2{margin:0;font-size:1.25rem;color:#162730;font-weight:700}
        .controls .form-control{height:42px}
        .table-wrap{ max-height:60vh; overflow:auto; }
        .controls{ margin-bottom:12px; }
        @media(min-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
    <!-- Sidebar (keeps navigation visible) -->
    {% include '_sidebar.html' %}

    <div id="content" class="container">
        <div class="topbar">
            <h2>Base de Talentos</h2>
            <div>
                <a href="/download/base_talentos" class="btn btn-success btn-sm">Descargar Excel/CSV</a>
            </div>
        </div>

        <div class="controls d-flex mb-3">
            <input id="searchBox" class="form-control mr-2" placeholder="Buscar candidato...">
            <select id="areaFilter" class="form-control" style="max-width:240px">
                <option value="">Filtrar por área</option>
            </select>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-wrap">
                    <table class="table table-striped table-sm" id="talentosTable">
                        <thead><tr id="talentosHead"></tr></thead>
                        <tbody id="talentosBody"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="text-muted" style="display:none">No hay registros.</div>
            </div>
        </div>
    </div>

    <script>
      $(function(){
        var rows = [];
        function detectAreaKeys(item){
          var keys = Object.keys(item||{}).map(function(k){ return k.toLowerCase(); });
          var candidates = ['area','área','areas','areas_detectadas','area_puesto','area'];
          for(var i=0;i<candidates.length;i++){
            var idx = keys.indexOf(candidates[i]);
            if(idx !== -1) return Object.keys(item)[idx];
          }
          if(keys.indexOf('areas')!==-1) return Object.keys(item)[keys.indexOf('areas')];
          return null;
        }

        function renderTable(data){
          rows = data || [];
          var head = $('#talentosHead'); head.empty();
          var body = $('#talentosBody'); body.empty();
          if(rows.length===0){ $('#emptyState').show(); return; } else { $('#emptyState').hide(); }
          var keys = Object.keys(rows[0]);
          keys.forEach(function(k){ head.append($('<th>').text(k)); });
          rows.forEach(function(r){
            var tr = $('<tr>');
            keys.forEach(function(k){
              var v = r[k]; if(Array.isArray(v)) v = v.join(', ');
              tr.append($('<td>').text(v==null? '': v));
            });
            body.append(tr);
          });
          populateAreaFilter(rows);
        }

        function populateAreaFilter(data){
          var sample = data[0]||{};
          var areaKey = detectAreaKeys(sample);
          var sel = $('#areaFilter'); sel.off('change'); sel.find('option:not(:first)').remove();
          if(!areaKey) return;
          var vals = {};
          data.forEach(function(r){ var v = r[areaKey]; if(Array.isArray(v)) v.forEach(function(x){ if(x) vals[x]=1; }); else if(v) vals[v]=1; });
          Object.keys(vals).sort().forEach(function(v){ sel.append($('<option>').val(v).text(v)); });
          sel.on('change', applyFilters);
        }

        function applyFilters(){
          var q = ($('#searchBox').val()||'').toLowerCase();
          var area = $('#areaFilter').val();
          var body = $('#talentosBody'); body.empty();
          if(rows.length===0){ $('#emptyState').show(); return; } else { $('#emptyState').hide(); }
          var keys = Object.keys(rows[0]);
          var areaKey = detectAreaKeys(rows[0])
          var filtered = rows.filter(function(r){
            var matchesQ = q === '' || keys.some(function(k){ var v = r[k]; if(v==null) return false; return String(Array.isArray(v)? v.join(' '): v).toLowerCase().indexOf(q) !== -1; });
            var matchesArea = !area || (areaKey && (function(){ var v = r[areaKey]; if(Array.isArray(v)) return v.indexOf(area)!==-1; return String(v)===String(area); })());
            return matchesQ && matchesArea;
          });
          if(filtered.length===0){ body.append($('<tr>').append($('<td colspan="'+keys.length+'" class="text-center text-muted">').text('No hay registros que coincidan.'))); return; }
          filtered.forEach(function(r){ var tr = $('<tr>'); keys.forEach(function(k){ var v = r[k]; if(Array.isArray(v)) v = v.join(', '); tr.append($('<td>').text(v==null? '': v)); }); body.append(tr); });
        }

        $('#searchBox').on('input', applyFilters);
        // highlight sidebar active link
        (function(){ var path = window.location.pathname; $('#sidebar a').removeClass('sidebar-active'); $('#sidebar a').each(function(){ var href=$(this).attr('href'); if(href===path || (href!=='/' && path.indexOf(href)===0)){ $(this).addClass('sidebar-active'); } }); })();

        $.getJSON('/api/base_talentos').done(function(data){ renderTable(data); }).fail(function(){ $('#emptyState').text('Error cargando la base de talentos').show(); });
      });
    </script>
</body>
</html>
